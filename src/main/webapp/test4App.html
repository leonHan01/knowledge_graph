<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>han's pic</title>
    <style>
        #div1 {
            width: 1950px;
            height: 10px;
            background: green;
            position: absolute;
            left: -1950px;
        }

        #div1 span {
            position: absolute;
            width: 20px;
            height: 10px;
            line-height: 20px;
            background: blue;
            right: -20px;
            top: 0px;
        }

        img {
            width: 980px;
            height: auto;
        }

        body {
            text-align: center
        }
    </style>
</head>
<body style="background-color: #555555">
<!--<input type="text" id="aaa">条件筛选</input>-->
<div id="div1">
    <span>~</span>
</div>
<div id="result" style="color:red"></div>
<button onclick="likePic(5)" style="width:300px;height:120px;font-size:50px;">5</button>
<button onclick="likePic(4)" style="width:300px;height:120px;font-size:50px;">4</button>
<button onclick="skipAuthor()" style="width:300px;height:120px;font-size:50px;">SKIP</button>
<button onclick="startQuery()" style="width:300px;height:120px;font-size:50px;">--刷新--</button>
<button onclick="deleteAll()" style="width:300px;height:120px;font-size:50px;">删除全部</button>
<script>
    var picId;

    function getJSON(url) {
        return new Promise(function (resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open('get', url, true);
            xhr.responseType = 'json';
            xhr.dataType = 'JSONP',  // 处理Ajax跨域问题
                xhr.onload = function () {
                    var status = xhr.status;
                    if (status == 200) {
                        console.log('成功：' + xhr.response);
                        resolve(xhr.response);
                    } else {
                        reject(status);
                    }
                };
            xhr.send();
        });
    }

    function startHttpQuery() {
        var url = "http://127.0.0.1:8080/getPic";
        getJSON(url).then(function (data) {
                picId = data.picId;
                var imageStr = "<img src=\"" + data.imgUrl + "\" alt=\"图片太大无法显示，试试刷新哦\"/>"
                document.getElementById("result").innerHTML = imageStr;
            },
            function (status) {
                alert('Something went wrong.');
            });
    }

    function likePic(score) {
        startMove(0);
        var url = "http://127.0.0.1:8080/like";
        if (null != picId) {
            //get方法的查询参数设置
            url = url + "?picId=" + picId + "&score=" + score;
        }
        getJSON(url).then(function (data) {
                var info = "喜欢成功：" + picId;
                picId = data.picId;
                var imageStr = "<img src=\"" + data.imgUrl + "\" alt=\"图片太大无法显示，试试刷新哦\"/>"
                document.getElementById("result").innerHTML = imageStr;
                startMove(-1950);
            },
            function (status) {
                alert('Something went wrong.');
            });
    }

    function skipAuthor() {
        startMove(0);
        var url = "http://127.0.0.1:8080/skipAuthor";
        getJSON(url).then(function (data) {
                picId = data.picId;
                var imageStr = "<img src=\"" + data.imgUrl + "\" alt=\"图片太大无法显示，试试刷新哦\" style=\"height:auto;width:3600px;\"/>"
                document.getElementById("result").innerHTML = imageStr;
                startMove(-1950);
            },
            function (status) {
                alert('Something went wrong.');
            });
    }

    function deleteAll() {
        startMove(0);
        var url = "http://127.0.0.1:8080/deleteAll";
        getJSON(url).then(function (data) {
                picId = data.picId;
                var imageStr = "<img src=\"" + data.imgUrl + "\" alt=\"图片太大无法显示，试试刷新哦\" style=\"height:auto;width:3600px;\"/>"
                document.getElementById("result").innerHTML = imageStr;
                startMove(-1950);
            },
            function (status) {
                alert('Something went wrong.');
            });
    }

    function unlikePic() {
        startMove(0);
        var url = "http://127.0.0.1:8080/unlike";
        if (null != picId) {
            //get方法的查询参数设置
            url = url + "?picId=" + picId;
        }
        getJSON(url).then(function (data) {
                var info = "删除成功：" + picId;
                if (data.picId != -1) {
                    picId = data.picId;
                    var imageStr = "<img src=\"" + data.imgUrl + "\" alt=\"图片太大无法显示，试试刷新哦\"/>"
                    document.getElementById("result").innerHTML = imageStr;
                    startMove(-1950);
                }
            },
            function (status) {
                alert('Something went wrong.');
            });
    }

    function startQuery() {
        //var bank=document.getElementById("aaa").value;
        startHttpQuery();
    }

    var timer = null;

    function startMove(iTarget) {
        var oDiv = document.getElementById('div1');
        clearInterval(timer);
        timer = setInterval(function () {
            var speed = 5;
            if (oDiv.offsetLeft > iTarget) {
                speed = -50;
            }
            if (oDiv.offsetLeft == iTarget) {
                clearInterval(timer);
            } else {
                oDiv.style.left = oDiv.offsetLeft + speed + 'px';
            }
        }, 30);
    }

    var touchTime = 0;

    function _touch() {
        var startx;//让startx在touch事件函数里是全局性变量。
        var endx;

        var el = document.getElementById('result');

        function cons() {   //独立封装这个事件可以保证执行顺序，从而能够访问得到应该访问的数据。
            console.log(starty, endy);
            if (startx - endx > 150) {  //判断左右移动程序
                likePic(2);  //向左滑动
            } else if (endy - starty > 250) {
                //alert("滑动距离:" + (endy - starty));
            } else if (starty - endy > 200) {
                //likePic(1);
            } else if (endx - startx > 150) {
                likePic(3); //向右滑动
            }
            else if (startx - endx == 0 && starty - endy == 0) {
                touchTime++;
                setTimeout(function () {
                    if (touchTime > 1) {
                        //双击
                        touchTime = 0;
                        likePic(1);
                        //startQuery();
                        touchTime = 0;
                    } else if (touchTime == 1) {
                        touchTime = 0;
                        //startQuery();
                        unlikePic();
                        touchTime = 0;
                    }
                }, 450);
            }
        }

        el.addEventListener('touchstart', function (e) {
            var touch = e.changedTouches;
            startx = touch[0].clientX;
            starty = touch[0].clientY;
        });
        el.addEventListener('touchend', function (e) {
            var touch = e.changedTouches;
            endx = touch[0].clientX;
            endy = touch[0].clientY;
            cons();  //startx endx 的数据收集应该放在touchend事件后执行，而不是放在touchstart事件里执行，这样才能访问到touchstart和touchend这2个事件产生的startx和endx数据。另外startx和endx在_touch事件函数里是全局性的，所以在此函数中都可以访问得到，所以只需要注意事件执行的先后顺序即可。
        });
    }

    _touch()

</script>
</body>
</html>